<html xmlns:f="http://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers"
      data-namespace-typo3-fluid="true">

<f:layout name="Default" />

<f:section name="main">
    <div class="tts-checkout">
        <h1 class="tts-checkout__title mb-5">Kasse</h1>

        <f:if condition="{cartItems}">
            <f:then>
                <f:if condition="{isUserLoggedIn}">
                    <f:then>
                        <f:form action="process" controller="Checkout" class="tts-checkout__form">
                            <div class="row g-4">
                                <div class="col-lg-8">
                                    <!-- Kundendaten -->
                                    <section class="mb-5">
                                        <div class="d-flex align-items-center mb-4">
                                            <span class="badge bg-primary rounded-circle p-2" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">1</span>
                                            <h2 class="ms-3 mb-0">Kundendaten</h2>
                                        </div>
                                        <div class="row g-3">
                                            <div class="col-sm-6">
                                                <label for="customerFirstName" class="form-label">Vorname *</label>
                                                <f:form.textfield name="order[customerFirstName]" id="customerFirstName" class="form-control" value="{frontendUser.first_name}" required="required" />
                                            </div>
                                            <div class="col-sm-6">
                                                <label for="customerLastName" class="form-label">Nachname *</label>
                                                <f:form.textfield name="order[customerLastName]" id="customerLastName" class="form-control" value="{frontendUser.last_name}" required="required" />
                                            </div>
                                            <div class="col-12">
                                                <label for="customerEmail" class="form-label">E-Mail *</label>
                                                <f:form.textfield name="order[customerEmail]" id="customerEmail" type="email" class="form-control" value="{frontendUser.email}" required="required" />
                                            </div>
                                            <div class="col-sm-6">
                                                <label for="customerPhone" class="form-label">Telefon</label>
                                                <f:form.textfield name="order[customerPhone]" id="customerPhone" type="tel" class="form-control" value="{frontendUser.mobile}" />
                                            </div>
                                            <div class="col-sm-6">
                                                <label for="customerCompany" class="form-label">Firma</label>
                                                <f:form.textfield name="order[customerCompany]" id="customerCompany" class="form-control" value="{frontendUser.company}" />
                                            </div>
                                        </div>
                                    </section>

                                    <!-- Rechnungsadresse -->
                                    <section class="mb-5">
                                        <div class="d-flex align-items-center mb-4">
                                            <span class="badge bg-primary rounded-circle p-2" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">2</span>
                                            <h2 class="ms-3 mb-0">Rechnungsadresse</h2>
                                        </div>
                                        <div class="row g-3">
                                            <div class="col-12">
                                                <label for="billingStreet" class="form-label">Stra√üe und Hausnummer *</label>
                                                <f:form.textfield name="order[billingStreet]" id="billingStreet" class="form-control" value="{frontendUser.address}" required="required" />
                                            </div>
                                            <div class="col-sm-6">
                                                <label for="billingZip" class="form-label">PLZ *</label>
                                                <f:form.textfield name="order[billingZip]" id="billingZip" class="form-control" value="{frontendUser.zip}" required="required" />
                                            </div>
                                            <div class="col-sm-6">
                                                <label for="billingCity" class="form-label">Ort *</label>
                                                <f:form.textfield name="order[billingCity]" id="billingCity" class="form-control" value="{frontendUser.city}" required="required" />
                                            </div>
                                            <div class="col-12">
                                                <label for="billingCountry" class="form-label">Land *</label>
                                                <f:form.select name="order[billingCountry]" id="billingCountry" options="{countries}" value="{frontendUser.country}" class="form-select" required="required" />
                                            </div>
                                        </div>
                                    </section>

                                    <!-- Versandart -->
                                    <section class="mb-5">
                                        <div class="d-flex align-items-center mb-4">
                                            <span class="badge bg-primary rounded-circle p-2" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">3</span>
                                            <h2 class="ms-3 mb-0">Versandart *</h2>
                                        </div>
                                        <f:if condition="{selectedShippingMethod}">
                                            <f:then>
                                                <div class="row g-2" id="shippingMethodsGroup">
                                                    <div class="col-12">
                                                        <f:form.radio name="order[shippingMethod]" id="shipping_{selectedShippingMethod.uid}" value="{selectedShippingMethod.uid}" checked="1" class="btn-check tts-shipping-method-radio" data-price="{selectedShippingMethod.price}" required="required" />
                                                        <label for="shipping_{selectedShippingMethod.uid}" class="btn btn-outline-secondary w-100 p-3 text-start d-flex gap-3 align-items-start">
                                                            <f:if condition="{selectedShippingMethod.logo}">
                                                                <img src="{selectedShippingMethod.logo}" alt="{selectedShippingMethod.provider}" style="max-width: 50px; height: auto; flex-shrink: 0;" />
                                                            </f:if>
                                                            <div class="flex-grow-1">
                                                                <h5 class="mb-0 fw-bold">{selectedShippingMethod.title}</h5>
                                                                <p class="mb-1 text-muted small">{selectedShippingMethod.provider}</p>
                                                                <f:if condition="{selectedShippingMethod.description}">
                                                                    <p class="mb-0 small">{selectedShippingMethod.description}</p>
                                                                </f:if>
                                                            </div>
                                                            <div class="ms-auto text-end flex-shrink-0">
                                                                <strong>+<f:format.currency currencySign="‚Ç¨" decimalSeparator="," thousandsSeparator=".">{selectedShippingMethod.price}</f:format.currency></strong>
                                                            </div>
                                                        </label>
                                                    </div>
                                                </div>
                                            </f:then>
                                            <f:else>
                                                <div class="alert alert-warning">
                                                    Keine passende Versandart f√ºr das aktuelle Gesamtgewicht ({totalWeight} kg) gefunden.
                                                </div>
                                            </f:else>
                                        </f:if>
                                    </section>

                                    <!-- Lieferadresse -->
                                    <section class="mb-5">
                                        <div class="d-flex align-items-center mb-4">
                                            <span class="badge bg-primary rounded-circle p-2" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">4</span>
                                            <h2 class="ms-3 mb-0">Lieferadresse</h2>
                                        </div>

                                        <div class="mb-4">
                                            <div class="form-check">
                                                <f:form.checkbox name="order[shippingSameAsBilling]" id="shippingSameAsBilling" value="1" checked="1" class="form-check-input" />
                                                <label for="shippingSameAsBilling" class="form-check-label">
                                                    Lieferadresse entspricht der Rechnungsadresse
                                                </label>
                                            </div>
                                        </div>

                                        <div id="shippingAddressFields">
                                            <div class="row g-3">
                                                <div class="col-sm-6">
                                                    <label for="shippingFirstName" class="form-label">Vorname</label>
                                                    <f:form.textfield name="order[shippingFirstName]" id="shippingFirstName" class="form-control" />
                                                </div>
                                                <div class="col-sm-6">
                                                    <label for="shippingLastName" class="form-label">Nachname</label>
                                                    <f:form.textfield name="order[shippingLastName]" id="shippingLastName" class="form-control" />
                                                </div>
                                                <div class="col-12">
                                                    <label for="shippingCompany" class="form-label">Firma</label>
                                                    <f:form.textfield name="order[shippingCompany]" id="shippingCompany" class="form-control" />
                                                </div>
                                                <div class="col-12">
                                                    <label for="shippingStreet" class="form-label">Stra√üe und Hausnummer</label>
                                                    <f:form.textfield name="order[shippingStreet]" id="shippingStreet" class="form-control" />
                                                </div>
                                                <div class="col-sm-6">
                                                    <label for="shippingZip" class="form-label">PLZ</label>
                                                    <f:form.textfield name="order[shippingZip]" id="shippingZip" class="form-control" />
                                                </div>
                                                <div class="col-sm-6">
                                                    <label for="shippingCity" class="form-label">Ort</label>
                                                    <f:form.textfield name="order[shippingCity]" id="shippingCity" class="form-control" />
                                                </div>
                                                <div class="col-12">
                                                    <label for="shippingCountry" class="form-label">Land</label>
                                                    <f:form.select name="order[shippingCountry]" id="shippingCountry" options="{countries}" class="form-select" />
                                                </div>
                                            </div>
                                        </div>
                                    </section>

                                    <!-- Zahlungsart -->
                                    <section class="mb-5">
                                        <div class="d-flex align-items-center mb-4">
                                            <span class="badge bg-primary rounded-circle p-2" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">5</span>
                                            <h2 class="ms-3 mb-0">Zahlungsart *</h2>
                                        </div>
                                        <div class="row g-2" id="paymentMethodsGroup">
                                             <f:for each="{paymentMethods}" as="paymentMethod">
                                                 <div class="col-sm-6 col-md-4">
                                                     <f:form.radio name="order[paymentMethod]" id="payment_{paymentMethod.uid}" value="{paymentMethod.uid}" checked="{f:if(condition:'{selectedPaymentMethod} && {selectedPaymentMethod.uid} == {paymentMethod.uid}', then:1, else:0)}" class="btn-check tts-payment-method-radio" required="required" autocomplete="off" />
                                                     <label for="payment_{paymentMethod.uid}" class="btn btn-outline-secondary w-100 d-flex flex-column align-items-center p-3">
                                                         <f:if condition="{paymentMethod.icon}">
                                                             <f:image image="{paymentMethod.icon}" alt="" width="50" height="50" />
                                                         </f:if>
                                                         <span class="mt-2 small">{paymentMethod.title}</span>
                                                     </label>
                                                 </div>
                                             </f:for>
                                         </div>
                                        <div class="alert alert-danger mt-3" id="paymentMethodError" style="display: none;">
                                            Bitte w√§hlen Sie eine Zahlungsart aus
                                        </div>
                                    </section>

                                    <!-- Bemerkungen -->
                                    <section class="mb-5">
                                        <div class="d-flex align-items-center mb-4">
                                            <span class="badge bg-primary rounded-circle p-2" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">6</span>
                                            <h2 class="ms-3 mb-0">Bemerkungen</h2>
                                        </div>
                                        <div>
                                            <label for="comment" class="form-label">Anmerkungen zur Bestellung</label>
                                            <f:form.textarea name="order[comment]" id="comment" rows="4" class="form-control" placeholder="Besondere W√ºnsche oder Hinweise..." />
                                        </div>
                                    </section>
                                </div>

                                <!-- Bestell√ºbersicht Sidebar -->
                                <div class="col-lg-4">
                                    <div class="card border-0 shadow-sm sticky-top" style="top: 20px;">
                                        <div class="card-body">
                                            <h5 class="card-title mb-4">Ihre Bestellung</h5>

                                            <div class="mb-4">
                                                <f:for each="{cartItems}" as="item">
                                                    <div class="d-flex justify-content-between align-items-start mb-3 pb-3 border-bottom" style="font-size: 0.9rem;">
                                                        <div>
                                                            <strong>{item.quantity}√ó</strong> {item.product.title}
                                                        </div>
                                                        <div class="text-end">
                                                            <f:format.currency currencySign="‚Ç¨" decimalSeparator="," thousandsSeparator=".">{item.subtotalNet}</f:format.currency>
                                                        </div>
                                                    </div>
                                                </f:for>
                                            </div>

                                            <div class="mb-3">
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span>Netto:</span>
                                                    <span><f:format.currency currencySign="‚Ç¨" decimalSeparator="," thousandsSeparator=".">{totalNet}</f:format.currency></span>
                                                </div>
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span>MwSt.:</span>
                                                    <span><f:format.currency currencySign="‚Ç¨" decimalSeparator="," thousandsSeparator=".">{totalTax}</f:format.currency></span>
                                                </div>
                                                <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
                                                    <span>Versandkosten:</span>
                                                    <span id="shippingCostSummary">
                                                        <f:format.currency currencySign="‚Ç¨" decimalSeparator="," thousandsSeparator=".">{selectedShippingMethod.price}</f:format.currency>
                                                    </span>
                                                </div>
                                                <div class="d-flex justify-content-between">
                                                    <strong>Gesamtsumme (Brutto):</strong>
                                                    <strong id="totalSummary" data-total="{total}"><f:format.currency currencySign="‚Ç¨" decimalSeparator="," thousandsSeparator=".">{total}</f:format.currency></strong>
                                                </div>
                                            </div>

                                            <p class="small text-muted mb-3">Preise inkl. MwSt.</p>

                                            <f:link.page pageUid="{cartPid}" class="d-block text-center text-primary small mb-4" style="text-decoration: none;">
                                                Warenkorb bearbeiten
                                            </f:link.page>
                                        </div>
                                    </div>

                                    <!-- AGB & Bestellbutton -->
                                    <div class="mt-4">
                                        <div class="form-check mb-3">
                                            <f:form.checkbox name="order[acceptTerms]" id="acceptTerms" value="1" class="form-check-input" required="required" />
                                            <label for="acceptTerms" class="form-check-label small">
                                                Ich akzeptiere die <a href="{termsLink}" target="_blank">AGB</a> und habe die <a href="{privacyLink}" target="_blank">Datenschutzerkl√§rung</a> gelesen. *
                                            </label>
                                        </div>

                                        <div class="form-check mb-4">
                                            <f:form.checkbox name="order[acceptCancellation]" id="acceptCancellation" value="1" class="form-check-input" required="required" />
                                            <label for="acceptCancellation" class="form-check-label small">
                                                Ich habe die <a href="{cancellationLink}" target="_blank">Widerrufsbelehrung</a> zur Kenntnis genommen. *
                                            </label>
                                        </div>

                                        <button type="submit" class="btn btn-primary btn-lg w-100 mb-3">
                                            Zahlungspflichtig bestellen
                                        </button>

                                        <p class="text-center small text-muted">
                                            üîí Sichere Daten√ºbertragung
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </f:form>
                    </f:then>
                    <f:else>
                        <!-- Login / Registration Section for non-logged-in users -->
                        <div class="row g-4">
                            <div class="col-lg-8">
                                <div class="alert alert-info mb-5">
                                    <h3 class="alert-heading mb-3">Willkommen bei der Kasse!</h3>
                                    <p>Um Ihre Bestellung abzuschlie√üen, m√ºssen Sie sich anmelden oder registrieren.</p>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body">
                                        <h5 class="card-title mb-4">Ihre Bestellung</h5>
                                        <div class="mb-4">
                                            <f:for each="{cartItems}" as="item">
                                                <div class="d-flex justify-content-between align-items-start mb-3 pb-3 border-bottom" style="font-size: 0.9rem;">
                                                    <div>
                                                        <strong>{item.quantity}√ó</strong> {item.product.title}
                                                    </div>
                                                    <div class="text-end">
                                                        <f:format.currency currencySign="‚Ç¨" decimalSeparator="," thousandsSeparator=".">{item.subtotalNet}</f:format.currency>
                                                    </div>
                                                </div>
                                            </f:for>
                                        </div>
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between">
                                                <strong>Gesamtsumme (Brutto):</strong>
                                                <strong><f:format.currency currencySign="‚Ç¨" decimalSeparator="," thousandsSeparator=".">{total}</f:format.currency></strong>
                                            </div>
                                        </div>
                                        <p class="small text-muted mb-4">Preise inkl. MwSt.</p>
                                        <f:if condition="{loginPid}">
                                            <f:link.page pageUid="{loginPid}" class="btn btn-primary w-100 mb-3">
                                                Anmelden
                                            </f:link.page>
                                        </f:if>
                                        <f:if condition="{registrationPid}">
                                            <f:link.page pageUid="{registrationPid}" class="btn btn-outline-primary w-100 mb-3">
                                                Registrieren
                                            </f:link.page>
                                        </f:if>
                                        <f:link.page pageUid="{cartPid}" class="d-block text-center text-primary small mb-4" style="text-decoration: none;">
                                            Warenkorb bearbeiten
                                        </f:link.page>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </f:else>
                </f:if>
            </f:then>
            <f:else>
                <div class="text-center py-5">
                    <p class="text-muted mb-4">Ihr Warenkorb ist leer. Bitte f√ºgen Sie zun√§chst Produkte hinzu.</p>
                    <f:link.page pageUid="{shopPid}" class="btn btn-primary">
                        Zum Shop
                    </f:link.page>
                </div>
            </f:else>
        </f:if>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const sameAsBillingCheckbox = document.getElementById('shippingSameAsBilling');
            const shippingFields = document.getElementById('shippingAddressFields');
            const form = document.querySelector('.tts-checkout__form');
            const paymentMethodRadios = document.querySelectorAll('.tts-payment-method-radio');
            const paymentMethodError = document.getElementById('paymentMethodError');
            const shippingMethodRadios = document.querySelectorAll('.tts-shipping-method-radio');
            const shippingMethodError = document.getElementById('shippingMethodError');
            const shippingCostDisplay = document.getElementById('shippingCostSummary');
            const totalDisplay = document.getElementById('totalSummary');
            const baseTotal = parseFloat(totalDisplay.dataset.total.replace(',', '.'));

            // Format currency
            function formatCurrency(amount) {
                return amount.toFixed(2).replace('.', ',') + ' ‚Ç¨';
            }

            // Update shipping cost and total
            function updateShippingCost() {
                const selectedShipping = document.querySelector('.tts-shipping-method-radio:checked');
                let shippingCost = 0;

                if (selectedShipping) {
                    shippingCost = parseFloat(selectedShipping.dataset.price) || 0;
                }

                if (shippingCostDisplay) {
                    shippingCostDisplay.textContent = formatCurrency(shippingCost);
                }

                if (totalDisplay) {
                    totalDisplay.textContent = formatCurrency(baseTotal + shippingCost);
                }
            }

            // Bind shipping method change
            shippingMethodRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    updateShippingCost();
                    if (shippingMethodError) {
                        shippingMethodError.style.display = 'none';
                    }
                });
            });

            // Toggle shipping address fields
            function toggleShippingFields() {
                const shippingInputs = shippingFields.querySelectorAll('input[type="text"], input[type="tel"], select');
                
                if (sameAsBillingCheckbox.checked) {
                    shippingFields.style.display = 'none';
                    // Remove required attribute when hidden
                    shippingInputs.forEach(input => {
                        input.removeAttribute('required');
                    });
                } else {
                    shippingFields.style.display = 'block';
                    // Add required attribute when visible
                    shippingInputs.forEach(input => {
                        // Only make text/tel/select inputs required, not company field
                        if (input.id !== 'shippingCompany') {
                            input.setAttribute('required', 'required');
                        }
                    });
                }
            }

            if (sameAsBillingCheckbox && shippingFields) {
                sameAsBillingCheckbox.addEventListener('change', toggleShippingFields);
                toggleShippingFields();
            }

            // Validate payment method selection
            function validatePaymentMethod() {
                let anyChecked = false;
                paymentMethodRadios.forEach(radio => {
                    if (radio.checked) {
                        anyChecked = true;
                    }
                });

                if (!anyChecked) {
                    paymentMethodError.style.display = 'block';
                    return false;
                } else {
                    paymentMethodError.style.display = 'none';
                    return true;
                }
            }

            // Validate shipping method selection
            function validateShippingMethod() {
                let anyChecked = false;
                shippingMethodRadios.forEach(radio => {
                    if (radio.checked) {
                        anyChecked = true;
                    }
                });

                if (!anyChecked) {
                    if (shippingMethodError) {
                        shippingMethodError.style.display = 'block';
                    }
                    return false;
                } else {
                    if (shippingMethodError) {
                        shippingMethodError.style.display = 'none';
                    }
                    return true;
                }
            }

            // Add form submit validation
            if (form) {
                form.addEventListener('submit', function(e) {
                    const paymentValid = validatePaymentMethod();
                    const shippingValid = validateShippingMethod();

                    if (!shippingValid) {
                        e.preventDefault();
                        document.getElementById('shippingMethodsGroup').scrollIntoView({ behavior: 'smooth', block: 'start' });
                        return;
                    }

                    if (!paymentValid) {
                        e.preventDefault();
                        document.getElementById('paymentMethodsGroup').scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            }

            // Hide error message when a payment method is selected
            paymentMethodRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        paymentMethodError.style.display = 'none';
                    }
                });
            });

            // Initialize shipping cost display
            updateShippingCost();
        });
    </script>
</f:section>

</html>
